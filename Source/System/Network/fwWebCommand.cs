#region Using framework
using System;
using System.Net;
using System.Text;
#endregion





namespace Pluton.SystemProgram.Devices
{
    ///--------------------------------------------------------------------------------------
    ///--------------------------------------------------------------------------------------







     ///=====================================================================================
    ///
    /// <summary>
    /// Команды отправляемые на сервер
    /// </summary>
    /// 
    ///--------------------------------------------------------------------------------------
    public class AWebCommand
            :
                AWebQuery
    {
        ///--------------------------------------------------------------------------------------
        private static readonly string  cURL = "http://candypeppypum.miracel.info/api/";   //запрос на установку соеденения
        private static readonly int     cVersionAPI = 1; //версия протокола
        ///--------------------------------------------------------------------------------------
        public  static readonly Uri     cURI = new Uri(cURL);

        
        ///--------------------------------------------------------------------------------------
        public readonly AWebParameters  parameters = new AWebParameters();
        public AWebParameters           result = null; //результат выполнения команды
        ///--------------------------------------------------------------------------------------



        ///--------------------------------------------------------------------------------------
        private string mError = null;
        ///--------------------------------------------------------------------------------------






         ///=====================================================================================
        ///
        /// <summary>
        /// constructor
        /// </summary>
        /// 
        ///--------------------------------------------------------------------------------------
        public AWebCommand()
        {
        }
        ///--------------------------------------------------------------------------------------






         ///=====================================================================================
        ///
        /// <summary>
        /// constructor
        /// </summary>
        /// 
        ///--------------------------------------------------------------------------------------
        public AWebCommand(string cmd)
        {
            parameters.addString("cmd", cmd);
        }
        ///--------------------------------------------------------------------------------------









         ///=====================================================================================
        ///
        /// <summary>
        /// преобразование команды в текст для отправки на сервер
        /// </summary>
        /// 
        ///--------------------------------------------------------------------------------------
        public string toString()
        {
            return parameters.toString();
        }
        ///--------------------------------------------------------------------------------------







         ///=====================================================================================
        ///
        /// <summary>
        /// начало выполнения команды
        /// </summary>
        /// 
        ///--------------------------------------------------------------------------------------
        protected override void onSend(WebClient web, int deviceID)
        {
            parameters.addInteger("deviceID", deviceID);
            parameters.addInteger("ver", cVersionAPI);

            web.Headers["Content-Type"] = "application/x-www-form-urlencoded";
            web.Encoding = Encoding.UTF8;
            web.UploadStringAsync(cURI, "POST", parameters.toString(), this);
        }
        ///--------------------------------------------------------------------------------------






         ///=====================================================================================
        ///
        /// <summary>
        /// команда выполнилась
        /// </summary>
        /// 
        ///--------------------------------------------------------------------------------------
        protected override void onExecute(string data)
        {
            result = new AWebParameters(data);
            if (result.count == 0)
            {
                mError = data;
            }
        }
        ///--------------------------------------------------------------------------------------







         ///=====================================================================================
        ///
        /// <summary>
        /// очистить всю команду
        /// </summary>
        /// 
        ///--------------------------------------------------------------------------------------
        protected override void onClear()
        {
            parameters.clear();
            result = null;
            mError = null;
        }
        ///--------------------------------------------------------------------------------------






         ///=====================================================================================
        ///
        /// <summary>
        /// очистить всю команду
        /// </summary>
        /// 
        ///--------------------------------------------------------------------------------------
        public string error
        {
            get
            {
                return mError == null ? string.Empty : mError;
            }
        }
        ///--------------------------------------------------------------------------------------






    }
}
